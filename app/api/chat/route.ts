import OpenAI from 'openai';export const runtime='nodejs';export const dynamic='force-dynamic';function sys(kb:any[]=[]){if(!kb?.length)return 'You are a helpful assistant. Output math formulas in LaTeX when appropriate.';const parts=kb.map(d=>`### ${d.name}\n${d.content}`).join('\n\n');return `You are a helpful assistant. Knowledge base:\n\n${parts}`;}export async function POST(req:Request){try{const {message,kb}=await req.json();const client=new OpenAI({apiKey:process.env.OPENAI_API_KEY});const r=await client.responses.create({model:process.env.MODEL||'gpt-4o-mini',input:[{role:'system',content:sys(kb)},{role:'user',content:String(message||'')}],});return Response.json({reply:(r as any).output_text||''});}catch(e:any){console.error(e);return new Response(JSON.stringify({error:'OpenAI error',detail:e?.message}),{status:500});}}